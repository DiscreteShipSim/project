%Common pre

function [fire, transition] = COMMON_PRE(transition)
% function [fire, trans] = COMMON_PRE(trans)

pArrPort = get_place('p_Arr_Port');
DockArr = get_place('p_DockArr');
s_admin = get_place('p_sadmin');
Docked = get_place('p_Docked');
d_admin = get_place('p_dadmin');
ready_to_leave = get_place('p_ready_to_leave');
DockDep = get_place('p_DockDep');
finishLoad = get_place('p_finishLoad');
finishUnload = get_place('p_finishUnload');
Departed = get_place('p_Departed');

global global_info;

if (strcmpi(transition.name, 't_arr')),
    
    %index = mod(global_info.cr_index, 3)+1;
    %global_info.cr_index = global_info.cr_index + 1;
    %transition.new_color = global_info.cr(index);
    %fire = 1;
    %return
     fire = lt(pArrPort.tokens, 3);

    
elseif (strcmpi(transition.name, 't_wait')),
    fire = lt(DockArr.tokens, 3);

elseif (strcmpi(transition.name, 't_DArr1')),
    granted = request('t_DArr1', ... 
        {'small',1});
    transition.new_color = global_info.cr(1);
    fire = granted;

    
elseif (strcmpi(transition.name, 't_DArr2')),
    granted = request('t_DArr2', ... 
        {'medium',1});
    transition.new_color = global_info.cr(2);
    fire = granted;
    
elseif (strcmpi(transition.name, 't_DArr3')),
    granted = request('t_DArr3', ... 
        {'big',1});
    transition.new_color = global_info.cr(3);
    fire = granted;
    
elseif (strcmpi(transition.name, 't_load1')),
    granted = request(transition.name, ... 
        {'workers',3}); 
    fire = granted;   

elseif (strcmpi(transition.name, 't_load2')),
    granted = request(transition.name, ... 
        {'workers',5});
    fire = granted;   

elseif (strcmpi(transition.name, 't_load3')),
    granted = request(transition.name, ... 
        {'workers',8});
    fire = granted;   

elseif (strcmpi(transition.name, 't_unload1')),
    granted = request(transition.name, ... 
        {'workers',5});
    tokID1 = tokenEXColor('p_Docked',1,{'SmallColor'});
    transition.selected_tokens = tokID1;
    fire = and(tokID1,granted);
    
elseif (strcmpi(transition.name, 't_unload2')),
    granted = request(transition.name, ... 
        {'workers',5});
    tokID1 = tokenEXColor('p_Docked',1,{'MediumColor'});
    transition.selected_tokens = tokID1;
    fire = and(tokID1,granted)
    
elseif (strcmpi(transition.name, 't_unload3')),
    granted = request(transition.name, ... 
        {'workers',8});
    tokID1 = tokenEXColor('p_Docked',1,{'BigColor'});
    transition.selected_tokens = tokID1;
    fire = and(tokID1,granted)
    
elseif (strcmpi(transition.name, 't_request_to_leave')),
    fire = lt(ready_to_leave.tokens, 3);
                
elseif (strcmpi(transition.name, 't_depart')),
    fire = lt(Docked.tokens, 3);

elseif (strcmpi(transition.name, 't_Ddep1')),
    fire = lt(DockDep.tokens, 3);

    
elseif (strcmpi(transition.name, 't_Ddep2')),
    fire = lt(Docked.tokens, 3);
 
    
elseif (strcmpi(transition.name, 't_Ddep3')),
    fire = lt(Docked.tokens, 3);

    
else
    error([transition.name, ...
        ' is neither "t_arr", "t_wait", or "t_DArr1" ?????...']);
end;
